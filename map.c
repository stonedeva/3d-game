#include "./map.h"
#include "./player.h"
#include "./sound.h"
#include <time.h>
#include <stdio.h>
#include <errno.h>
#include <string.h>


MapType current_map_type = MAP_CAVE;
Tile map[MAP_WIDTH][MAP_HEIGHT] = {0};

Tile cave_map[MAP_WIDTH][MAP_HEIGHT] = {
    {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
    {1,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,1},
    {1,1,1,1,1,0,0,1,2,1,1,1,12,1,0,0,0,0,0,0,0,0,0,1},
    {1,0,0,0,0,1,2,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1},
    {1,1,1,1,0,0,8,0,0,2,0,0,1,0,0,0,0,0,0,0,0,0,0,1},
    {1,0,0,0,1,1,2,0,2,0,1,1,0,0,0,0,0,0,0,0,0,0,0,1},
    {1,0,0,0,0,0,2,3,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,1},
    {1,0,0,0,0,2,0,0,0,0,0,2,1,0,0,0,0,1,1,1,0,0,0,1},
    {1,0,0,0,0,2,0,0,0,0,0,2,0,1,0,1,1,0,0,1,1,0,0,1},
    {1,0,0,0,2,0,0,0,0,0,0,3,0,0,1,0,0,0,0,0,1,0,0,1},
    {1,0,0,0,2,0,0,0,0,0,0,2,0,0,0,0,1,1,0,0,1,0,0,1},
    {1,0,0,0,0,2,2,0,2,2,2,0,1,0,0,1,0,1,0,0,1,0,0,1},
    {1,0,0,0,0,0,1,3,1,0,0,0,0,1,0,1,0,0,0,0,1,0,0,1},
    {1,0,0,0,0,0,1,0,1,1,1,1,1,1,1,1,0,1,1,1,1,0,0,1},
    {1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1},
    {1,0,0,0,0,0,1,1,1,0,0,0,0,1,1,1,1,1,0,0,0,0,0,1},
    {1,0,0,0,0,0,0,0,0,1,1,0,0,1,0,0,0,0,0,0,0,0,0,1},
    {1,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,1},
    {1,0,0,0,0,0,0,0,0,2,2,3,2,2,0,0,0,0,0,0,0,0,0,1},
    {1,0,0,0,0,0,0,0,0,2,0,0,0,2,0,0,0,0,0,0,0,0,0,1},
    {1,0,0,0,0,0,0,0,0,2,0,0,0,2,0,0,0,0,0,0,0,0,0,1},
    {1,0,0,0,0,0,0,0,0,2,0,0,0,2,0,0,0,0,0,0,0,0,0,1},
    {1,0,0,0,0,0,0,0,0,2,0,0,0,2,0,0,0,0,0,0,0,0,0,1},
    {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1}
};

Tile ice_map[MAP_WIDTH][MAP_HEIGHT] = {
    {10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10},
    {10,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,10},
    {10,10,10,10,10,10,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,10},
    {10,00,00,00,00,8,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,10},
    {10,10,10,10,10,10,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,10},
    {10,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,10},
    {10,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,10},
    {10,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,10},
    {10,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,10},
    {10,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,10},
    {10,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,10},
    {10,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,10},
    {10,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,10},
    {10,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,10},
    {10,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,10},
    {10,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,10},
    {10,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,10},
    {10,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,10},
    {10,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,10},
    {10,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,10},
    {10,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,10},
    {10,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,10},
    {10,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,10},
    {10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10}
};

void map_switch(Player* p, MapType type)
{
    current_map_type = type;
    size_t map_sz = MAP_WIDTH*MAP_HEIGHT*sizeof(Tile);

    p->pos.y += 0.5f;

    switch (type) {
    case MAP_CAVE:
	memcpy(map, cave_map, map_sz);
	break;
    case MAP_ICE:
	memcpy(map, ice_map, map_sz);
	break;
    }
}

void map_load_from_file(char* file_path)
{
    FILE* fp = fopen(file_path, "rb");
    if (!fp) {
	fprintf(stderr, "ERROR: fopen(): Failed to open map file: %s\n",
		strerror(errno));
	exit(1);
    }

    size_t n = fread(map, 1, MAP_WIDTH*MAP_HEIGHT, fp);
    if (n != MAP_WIDTH*MAP_HEIGHT) {
	fprintf(stderr, "ERROR: fread(): Expected %d bytes read %zu bytes: %s\n",
		MAP_WIDTH*MAP_HEIGHT, n, strerror(errno));
	exit(1);
    }

    fclose(fp);
}

void map_break_block(int map_x, int map_y, Tile last_tile)
{
    Tile tile = map[map_x][map_y];
    if (tile != last_tile) {
	map[map_x][map_y] = tile + 1;
    } else {
	map[map_x][map_y] = TILE_EMPTY;
	sound_play(SOUND_WALL_DESTROY);
    }
}

void map_dump()
{
    for (int y = 0; y < MAP_HEIGHT; y++) {
	printf("{");
	for (int x = 0; x < MAP_WIDTH; x++) {
	    printf("%d, ", map[x][y]);
	}
	printf("}\n");
    }
}
